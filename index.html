<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>My application</title>
        <style>
            body { margin: 0; }
                #blocker {
                    position: absolute;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0,0,0,0.5);
                }

                #instructions {
                    width: 100%;
                    height: 100%;

                    display: -webkit-box;
                    display: -moz-box;
                    display: box;

                    -webkit-box-orient: horizontal;
                    -moz-box-orient: horizontal;
                    box-orient: horizontal;

                    -webkit-box-pack: center;
                    -moz-box-pack: center;
                    box-pack: center;

                    -webkit-box-align: center;
                    -moz-box-align: center;
                    box-align: center;

                    color: #ffffff;
                    text-align: center;
                    font-family: Arial;
                    font-size: 14px;
                    line-height: 24px;

                    cursor: pointer;
                }
        </style>
    </head>
    <body>
        <div id="blocker">
            <div id="instructions">
                <span style="font-size:36px">Cliquer pour jouer</span>
                <br /><br />
                Bouger: ZQSD<br/>
                Regarder: Souris
            </div>
        </div>
        <script type="module">
            import * as THREE from "https://threejs.org/build/three.module.js";
            import { PointerLockControls } from 'https://threejs.org/examples/jsm/controls/PointerLockControls.js';

            /*
                Variables
            */
            let camera, scene, renderer, controls;

			const collisions = [];

			let moveForward = false;
			let moveBackward = false;
			let moveLeft = false;
            let moveRight = false;

			let prevTime = performance.now();
			const velocity = new THREE.Vector3();
			const direction = new THREE.Vector3();
			const vertex = new THREE.Vector3();
            const color = new THREE.Color();

            init();
            animate();

            function init(){
                /*
                    Initialisation du jeu
                */
               
                //Création du context
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight,
                    0.1, 1000);

                renderer = new THREE.WebGLRenderer( { antialias: true } );
                renderer.setPixelRatio( window.devicePixelRatio );
                renderer.setSize( window.innerWidth, window.innerHeight );

                document.body.appendChild( renderer.domElement );
                window.addEventListener( 'resize', onWindowResize );

                //Hauteur du personnage
                camera.position.y = 7.5
                
                //Couleur de fond
                scene.background = new THREE.Color( 0x82898f );


                //    Gestion du curseur,
                //        Curseur prit par la fenêtre quand on clique
                //        sur la fénêtre.

                controls = new PointerLockControls( camera, document.body );
                scene.add( controls.getObject() );
                const blocker = document.getElementById( 'blocker' );
                const instructions = document.getElementById( 'instructions' );

                instructions.addEventListener( 'click', function () {
                    controls.lock();
                } );
                controls.addEventListener( 'lock', function () {
                    instructions.style.display = 'none';
                    blocker.style.display = 'none';
                } );
                controls.addEventListener( 'unlock', function () {
                    blocker.style.display = 'block';
                    instructions.style.display = '';
                } );


                /*
                    Gestion des touches
                */
                const onKeyDown = function ( event ) { //On appuie sur la touche donc on active l'action qui va
                    switch ( event.code ) {

                        case 'ArrowUp':
                        case 'KeyW':
                            moveForward = true;
                            break;

                        case 'ArrowLeft':
                        case 'KeyA':
                            moveLeft = true;
                            break;

                        case 'ArrowDown':
                        case 'KeyS':
                            moveBackward = true;
                            break;

                        case 'ArrowRight':
                        case 'KeyD':
                            moveRight = true;
                            break;
                    }
                };
                const onKeyUp = function ( event ) { //On relâche la touche donc on arrête l'action qu'on faisait
                    switch ( event.code ) {

                        case 'ArrowUp':
                        case 'KeyW':
                            moveForward = false;
                            break;

                        case 'ArrowLeft':
                        case 'KeyA':
                            moveLeft = false;
                            break;

                        case 'ArrowDown':
                        case 'KeyS':
                            moveBackward = false;
                            break;

                        case 'ArrowRight':
                        case 'KeyD':
                            moveRight = false;
                            break;

                    }
                };
                
                document.addEventListener( 'keydown', onKeyDown );
                document.addEventListener( 'keyup', onKeyUp );


                /*
                    Création de la scene
                */
                //Ajout d'un sol
                let floorGeometry = new THREE.PlaneGeometry( 30, 30 );
                const floorMaterial = new THREE.MeshBasicMaterial( {color: 0xffffff, side: THREE.DoubleSide} );
                const floor = new THREE.Mesh( floorGeometry, floorMaterial );
                floor.rotation.x = Math.PI / 2;
                scene.add( floor );

                //Ajout scène crée dans l'editeur de threejs.org
                const loader = new THREE.ObjectLoader();
                loader.load(
                    //Modèle JSON à charger
                    "models/scene.json",

                    //Callback : une fois le chargement fini
                    function ( obj ) {
                        detectCollision(obj);
                        scene.add( obj );
                    },

                    //Callback : pendant le chargement
                    () => {},

                    //Callback : erreur pendant le chargement
                    function ( err ) {
                        console.error( 'Error : ', err );
                    }
                );
            }

            function onWindowResize() {
                /*
                    On change les paramètres d'affichage de la page pour qu'elle s'adapte à la nouvelle taille
                    en cas de reduction de fenêtre.
                */
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();

                renderer.setSize( window.innerWidth, window.innerHeight );
            }

            function detectCollision(scene){
                /*
                    Ajout de chaque mesh de la scène dans le tableau collision
                */
                for(let i = 0; i < scene.children.length; i++){
                    if (scene.children[i].type == "Mesh"){
                        collisions.push(scene.children[i])
                    }
                }
            }

            function movePerson(){
                /*
                    Gestion du déplacement du personnage
                */
                const time = performance.now();
                if ( controls.isLocked === true) { //Si le curseur est prit dans le jeu donc qu'il joue
                    //On s'occupe ici surtout de la velocité du personnage,
                    //  de façon à ce que ce ne soit pas des mouvements saccadés
                    const delta = ( time - prevTime ) / 1000;

                    velocity.x -= velocity.x * 10.0 * delta;
                    velocity.z -= velocity.z * 10.0 * delta;

                    direction.z = Number( moveForward ) - Number( moveBackward );
                    direction.x = Number( moveRight ) - Number( moveLeft );
                    direction.normalize(); // On s'assure que on va à la même vitesse partout

                    if ( moveForward || moveBackward ) velocity.z -= direction.z * 300.0 * delta;
                    if ( moveLeft || moveRight ) velocity.x -= direction.x * 300.0 * delta;

                    controls.moveRight( - velocity.x * delta );
                    controls.moveForward( - velocity.z * delta );
                }

                prevTime = time;
            }

            function animate() {
                /*
                    Code exécuté à chaque image affiché par le jeu
                */
                requestAnimationFrame( animate ); //Récursion

                // 
                // Collisions
                //

                //Vecteurs utilisés par le raycaster pour detecter tout les objets à gauche, devant, à droite et derrière
                var vectors = [new THREE.Vector3(0, 0, -1),
                    new THREE.Vector3(1, 0, 0),
                    new THREE.Vector3(0, 0, 1),
                    new THREE.Vector3(-1, 0, 0),]

                //Boucle s'exécutant sur la liste des vecteurs
                for (let i = 0; i < vectors.length; i++){
                    //On modifie le vecteur pour l'adapter à notre caméra et au raycaster
                    vectors[i] = camera.localToWorld(vectors[i])
                    vectors[i].sub(camera.position)
                    var ray = new THREE.Raycaster( camera.position, vectors[i]);
                    var intersects = ray.intersectObjects( collisions );

                    //On teste si le raycaster trouve quelque chose sur un des vecteurs
                    //  et on regarde si la distance avec lui est en dessous de 5
                    //  Si oui alors on arrete de bouger le personnage
                    if ( intersects.length > 0 && intersects[ 0 ].distance < 5){
                        //Switch pour détecter quel coté bloquer en fonction du vecteur utilisé dans la boucle
                        //  (obligé d'utilliser ça si je voulais mettre tout le code dans une boucle)
                        switch(i){
                            case 0:
                                moveForward = false
                                break;
                            case 1:
                                moveRight = false;
                                break;
                            case 2:
                                moveBackward = false;
                                break;
                            case 3:
                                moveLeft = false;
                                break;
                        }
                    }
                }

                movePerson()
                renderer.render( scene, camera );
            }
        </script>
    </body>
</html>